---
1---
title: "Refbank Data Harmonization"
output: html_document
date: "2025-02-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r setup, message=FALSE, warning=FALSE}
install.packages(c("dplyr", "tidyverse", "stringr", "janitor", "data.table"))

```

```{r harmonization for dataset #1}
library(dplyr)
library(tidyverse)
library(stringr)
library(janitor)
library(data.table)

setwd("/Users/spurtinimbali/Desktop/LangCog/tangrams/data") 
list.files()

# Reading files
df_base <- read_csv("tangrams.csv")
df_seq  <- read_csv("tangramsSequential_collapsed.csv")
df_unc  <- read_csv("tangramsUnconstrained.csv")

# Standardizing column names
df_base <- df_base %>% rename_all(~ tolower(trimws(.)))
df_seq  <- df_seq %>% rename_all(~ tolower(trimws(.)))
df_unc  <- df_unc %>% rename_all(~ tolower(trimws(.)))

# Combining all columns
all_columns <- union(names(df_base), union(names(df_seq), names(df_unc)))

# Adding missing columns to each dataframe
add_missing_columns <- function(df, all_columns) {
  missing_cols <- setdiff(all_columns, names(df))
  if(length(missing_cols) > 0) {
    for(col in missing_cols) {
      df[[col]] <- NA  # Filling missing columns with NA
    }
  }
  return(df[all_columns])  # Ensuring column order matches
}

df_base <- add_missing_columns(df_base, all_columns)
df_seq  <- add_missing_columns(df_seq, all_columns)
df_unc  <- add_missing_columns(df_unc, all_columns)

# Adding experiment column
df_base <- df_base %>% mutate(experiment = "Base")
df_seq  <- df_seq %>% mutate(experiment = "Sequential")
df_unc  <- df_unc %>% mutate(experiment = "Unconstrained")

# Merging data
harmonized_data <- bind_rows(df_base, df_seq, df_unc)

# Filling missing values
# - Numerical: Use mean
# - Categorical: Use the most common value (mode)

fill_na_with_mode <- function(x) {
  if(is.character(x) | is.factor(x)) {
    mode_value <- names(sort(table(x), decreasing = TRUE))[1]
    x[is.na(x)] <- mode_value
  }
  return(x)
}

fill_na_with_mean <- function(x) {
  if(is.numeric(x)) {
    x[is.na(x)] <- mean(x, na.rm = TRUE)
  }
  return(x)
}

harmonized_data <- harmonized_data %>% 
  mutate_if(is.character, fill_na_with_mode) %>% 
  mutate_if(is.numeric, fill_na_with_mean)

#Renaming columns as per schema
column_mapping <- c(
  "gameid"          = "game_id",
  "trialnum"        = "trial_num",
  "repetitionnum"   = "rep_num",
  "role"            = "role",
  "intendedname"    = "player_id",
  "intendedobj"     = "target_id",
  "clickedobj"      = "choice_id",
  "contents"        = "message",
  "timeelapsed"     = "time_to_choice",
  "objbox"          = "option_set"
)

harmonized_data <- harmonized_data %>% rename_with(~ recode(., !!!column_mapping))

#Calculating and adding msg_num
harmonized_data <- harmonized_data %>%
  mutate(group_id = cumsum((player_id != lag(player_id, default = first(player_id))) | 
                           (trial_num != lag(trial_num, default = first(trial_num)))))

harmonized_data <- harmonized_data %>%
  group_by(group_id) %>%
  mutate(message_num = row_number()) %>%
  ungroup() %>%
  select(-group_id) 

#Adding column for paper_id 
harmonized_data <- harmonized_data %>% mutate(paper_id = "kawkrobe-tangrams")

#Adding column for experiment_id 
harmonized_data <- harmonized_data %>%
  mutate(experiment_id = paste0(experiment, "-", taskversion))

#Creating file for user demographics
user_demographics <- harmonized_data %>%
  select(player_id, nativeenglish, paper_id, experiment_id, role) %>%  

print(head(user_demographics))
write_csv(user_demographics, "user_demographics.csv")

#Removing columns
columns_to_remove <- c("msgtime", "totallength", "thinkshuman", "comments", "ratepartner", "nativeenglish", "time", "correct"     , "numrawwords" , "repetitionscore", "taskversion", "experiment")
harmonized_data <- harmonized_data %>% select(-all_of(columns_to_remove))


# Saving harmonized dataset
write_csv(harmonized_data, "tangrams_harmonized.csv")

# Displaying first few rows
print(head(harmonized_data))
print(names(harmonized_data))
```


