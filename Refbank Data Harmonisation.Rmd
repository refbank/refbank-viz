---
1---
title: "Refbank Data Harmonization"
output: html_document
date: "2025-02-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r setup, message=FALSE, warning=FALSE}
install.packages(c("dplyr", "tidyverse", "stringr", "janitor"))
```

```{r harmonization for dataset #1}
library(dplyr)
library(tidyverse)
library(stringr)
library(janitor)

setwd("/Users/spurtinimbali/Desktop/LangCog/tangrams/data") 
list.files()

# Reading files
df_base <- read_csv("tangrams.csv")
df_seq  <- read_csv("tangramsSequential_collapsed.csv")
df_unc  <- read_csv("tangramsUnconstrained.csv")

# Standardizing column names
df_base <- df_base %>% rename_all(~ tolower(trimws(.)))
df_seq  <- df_seq %>% rename_all(~ tolower(trimws(.)))
df_unc  <- df_unc %>% rename_all(~ tolower(trimws(.)))

# Combining all columns
all_columns <- union(names(df_base), union(names(df_seq), names(df_unc)))

# Adding missing columns to each dataframe
add_missing_columns <- function(df, all_columns) {
  missing_cols <- setdiff(all_columns, names(df))
  if(length(missing_cols) > 0) {
    for(col in missing_cols) {
      df[[col]] <- NA  # Filling missing columns with NA
    }
  }
  return(df[all_columns])  # Ensuring column order matches
}

df_base <- add_missing_columns(df_base, all_columns)
df_seq  <- add_missing_columns(df_seq, all_columns)
df_unc  <- add_missing_columns(df_unc, all_columns)

# Adding experiment column
df_base <- df_base %>% mutate(experiment = "Base")
df_seq  <- df_seq %>% mutate(experiment = "Sequential")
df_unc  <- df_unc %>% mutate(experiment = "Unconstrained")

# Merging data
harmonized_data <- bind_rows(df_base, df_seq, df_unc)

# Filling missing values
# - Numerical: Use mean
# - Categorical: Use the most common value (mode)

fill_na_with_mode <- function(x) {
  if(is.character(x) | is.factor(x)) {
    mode_value <- names(sort(table(x), decreasing = TRUE))[1]
    x[is.na(x)] <- mode_value
  }
  return(x)
}

fill_na_with_mean <- function(x) {
  if(is.numeric(x)) {
    x[is.na(x)] <- mean(x, na.rm = TRUE)
  }
  return(x)
}

harmonized_data <- harmonized_data %>% 
  mutate_if(is.character, fill_na_with_mode) %>% 
  mutate_if(is.numeric, fill_na_with_mean)

# Saving harmonized dataset
write_csv(harmonized_data, "tangrams_harmonized.csv")

# Displaying first few rows
print(head(harmonized_data))
```

```{r harmonization for dataset #2}
setwd("/Users/spurtinimbali/Desktop/LangCog/multiparty-tangrams/data")

folders <- c("pilotB", "pilotC", "study1", "study1a", "study1b", 
             "study2a", "study2b", "study2c", "study3")

# Reading files 
read_data_with_source <- function(folder, filename) {
  file_path <- file.path(folder, filename)
  if (file.exists(file_path)) {
    df <- read_csv(file_path, col_types = cols(.default = "c")) %>%  # Read all as character first
      rename_all(~ tolower(trimws(.))) %>%  # Standardize column names
      mutate(source = folder)  # Track source folder
    return(df)
  } else {
    return(NULL)
  }
}

# Initializing empty lists for different datasets
games_list <- list()
rounds_list <- list()
player_inputs_list <- list()
chat_list <- list()
survey_list <- list()
other_data <- list()

# Looping through each folder to read files
for (folder in folders) {
  games_list[[folder]] <- read_data_with_source(folder, "games.csv")
  rounds_list[[folder]] <- read_data_with_source(folder, "rounds.csv")
  player_inputs_list[[folder]] <- read_data_with_source(folder, "player-inputs.csv")
  chat_list[[folder]] <- read_data_with_source(folder, "chat.csv")
  survey_list[[folder]] <- read_data_with_source(folder, "exit_survey.csv")
  
  other_data[[paste(folder, "word_matches", sep = "_")]] <- read_data_with_source(folder, "word_matches.csv")
  other_data[[paste(folder, "filtered_chat", sep = "_")]] <- read_data_with_source(folder, "filtered_chat.csv")
  other_data[[paste(folder, "treatments", sep = "_")]] <- read_data_with_source(folder, "treatments.csv")
}

# Function to automatically detect numeric columns and convert them
convert_numeric_columns <- function(df) {
  df %>%
    mutate(across(where(is.character), ~ ifelse(grepl("^-?\\d+(\\.\\d+)?$", .), as.numeric(.), .)))
}

# Function to combine all datasets safely
combine_dataframes <- function(data_list) {
  combined_df <- bind_rows(data_list, .id = "source") %>%
    convert_numeric_columns()  # Ensure numeric consistency
  return(combined_df)
}

# Merging datasets by type
games_df <- combine_dataframes(games_list)
rounds_df <- combine_dataframes(rounds_list)
player_inputs_df <- combine_dataframes(player_inputs_list)
chat_df <- combine_dataframes(chat_list)
survey_df <- combine_dataframes(survey_list)

other_df <- bind_rows(other_data, .id = "source") %>% convert_numeric_columns()

# Function to fill missing categorical values (avoids mode errors)
fill_na_with_mode <- function(x) {
  if(is.character(x) | is.factor(x)) {
    valid_values <- na.omit(x)  # Remove NA values before computing mode
    if (length(valid_values) == 0) {
      return(x)  # Return as is if all values are NA
    }
    mode_value <- names(sort(table(valid_values), decreasing = TRUE))[1]
    x[is.na(x)] <- mode_value
  }
  return(x)
}

# Function to fill missing numerical values
fill_na_with_mean <- function(x) {
  if(is.numeric(x)) {
    if (all(is.na(x))) {
      return(x)  # If entire column is NA, leave as is
    }
    x[is.na(x)] <- mean(x, na.rm = TRUE)
  }
  return(x)
}

harmonized_datasets <- list(games_df, rounds_df, player_inputs_df, chat_df, survey_df, other_df) %>%
  map(~ .x %>% mutate_if(is.character, fill_na_with_mode) %>% mutate_if(is.numeric, fill_na_with_mean))

# Saving harmonized datasets
write_csv(harmonized_datasets[[1]], "harmonized_games.csv")
write_csv(harmonized_datasets[[2]], "harmonized_rounds.csv")
write_csv(harmonized_datasets[[3]], "harmonized_player_inputs.csv")
write_csv(harmonized_datasets[[4]], "harmonized_chat.csv")
write_csv(harmonized_datasets[[5]], "harmonized_survey.csv")
write_csv(harmonized_datasets[[6]], "harmonized_other_data.csv")

print("Harmonization complete! Files saved as harmonized CSVs.")
print(head(harmonized_datasets[[1]]))
print(head(harmonized_datasets[[2]]))
print(head(harmonized_datasets[[3]]))
print(head(harmonized_datasets[[4]]))
print(head(harmonized_datasets[[5]]))
print(head(harmonized_datasets[[6]]))

```
