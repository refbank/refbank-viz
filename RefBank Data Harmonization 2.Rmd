---
title: "RefBank Data Harmonization 2"
output: html_document
date: "2025-03-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Markdown
```{r setup, message=FALSE, warning=FALSE}
install.packages(c("dplyr", "tidyverse", "janitor", "data.table"))

```


```{r harmonization for dataset #2}
library(dplyr)
library(tidyverse)
library(stringr)
library(janitor)
library(data.table)
setwd("/Users/spurtinimbali/Desktop/LangCog/multiparty-tangrams/data")

folders <- c("pilotB", "pilotC", "study1", "study1a", "study1b", 
             "study2a", "study2b", "study2c", "study3")

# Reading files 
read_data_with_source <- function(folder, filename) {
  file_path <- file.path(folder, filename)
  if (file.exists(file_path)) {
    df <- read_csv(file_path, col_types = cols(.default = "c")) %>%  # Read all as character first
      rename_all(~ tolower(trimws(.))) %>%  # Standardize column names
      mutate(source = folder)  # Track source folder
    return(df)
  } else {
    return(NULL)
  }
}

# Initializing empty lists for different datasets
games_list <- list()
rounds_list <- list()
player_inputs_list <- list()
chat_list <- list()
survey_list <- list()
other_data <- list()

# Looping through each folder to read files
for (folder in folders) {
  games_list[[folder]] <- read_data_with_source(folder, "games.csv")
  rounds_list[[folder]] <- read_data_with_source(folder, "rounds.csv")
  player_inputs_list[[folder]] <- read_data_with_source(folder, "player-inputs.csv")
  chat_list[[folder]] <- read_data_with_source(folder, "chat.csv")
  survey_list[[folder]] <- read_data_with_source(folder, "exit_survey.csv")
  
  other_data[[paste(folder, "word_matches", sep = "_")]] <- read_data_with_source(folder, "word_matches.csv")
  other_data[[paste(folder, "filtered_chat", sep = "_")]] <- read_data_with_source(folder, "filtered_chat.csv")
  other_data[[paste(folder, "treatments", sep = "_")]] <- read_data_with_source(folder, "treatments.csv")
}

# Function to automatically detect numeric columns and convert them
convert_numeric_columns <- function(df) {
  df %>%
    mutate(across(where(~ all(grepl("^[-+]?[0-9]*\\.?[0-9]+$", .), na.rm = TRUE)), as.numeric))
}

# Function to combine all datasets safely
combine_dataframes <- function(data_list) {
  combined_df <- bind_rows(data_list, .id = "source") %>%
    convert_numeric_columns()  # Ensure numeric consistency
  return(combined_df)
}

# Merging datasets by type
games_df <- combine_dataframes(games_list)
rounds_df <- combine_dataframes(rounds_list)
player_inputs_df <- combine_dataframes(player_inputs_list)
chat_df <- combine_dataframes(chat_list)
survey_df <- combine_dataframes(survey_list)

other_df <- bind_rows(other_data, .id = "source") %>% convert_numeric_columns()

# Function to fill missing categorical values (avoids mode errors)
fill_na_with_mode <- function(x) {
  if(is.character(x) | is.factor(x)) {
    valid_values <- na.omit(x)  # Remove NA values before computing mode
    if (length(valid_values) == 0) {
      return(x)  # Return as is if all values are NA
    }
    mode_value <- names(sort(table(valid_values), decreasing = TRUE))[1]
    x[is.na(x)] <- mode_value
  }
  return(x)
}

# Function to fill missing numerical values
fill_na_with_mean <- function(x) {
  if(is.numeric(x)) {
    if (all(is.na(x))) {
      return(x)  # If entire column is NA, leave as is
    }
    x[is.na(x)] <- mean(x, na.rm = TRUE)
  }
  return(x)
}

column_mapping <- c(
  "gameid"             = "game_id",
  "player_id"          = "player_id",
  "target"             = "target_id", 
  "response"           = "choice_id",
  "repnum"             = "rep_num",
  "role"               = "role",
  "text"               = "message",
  "time"               = "time_elapsed",
  "source"             = "experiment_id"
)

#Adding column for paper_id 
chat_df <- chat_df%>% mutate(paper_id = "vboyce-multiparty-tangrams")

#Adding column for option_set
chat_df <- chat_df %>% mutate(option_set = "/experiment/tangram_A.png,/experiment/tangram_B.png,/experiment/tangram_C.png,/experiment/tangram_D.png,/experiment/tangram_E.png,/experiment/tangram_F.png,/experiment/tangram_G.png,/experiment/tangram_H.png,/experiment/tangram_I.png,/experiment/tangram_J.png,/experiment/tangram_K.png,/experiment/tangram_L.png")


#Calculating and adding message_num
chat_df <- chat_df %>%
  mutate(group_id = cumsum(repnum != lag(repnum, default = first(repnum)))) %>%  # Only check repnum changes
  group_by(group_id) %>%
  mutate(message_num = row_number()) %>%
  ungroup() %>%
  select(-group_id)  

#Calculating and adding trail_num
chat_df<- chat_df %>%
  mutate(trial_group = cumsum(trialnum == 1)) %>%  # Increment when trialnum resets to 1
  group_by(trial_group) %>%
  mutate(trial_num = first(trial_group)) %>%  # Assign the same trial_num within each group
  ungroup() %>%
  select(-trial_group)

chat_df <- chat_df %>% rename_with(~ recode(., !!!column_mapping))

#Removing columns
columns_to_remove <- c("trialnum", "tangram", "numplayers", "total_num_words", "total_num_chars", "_id", "index" , "stageids", "createdat", "targetnum", "countcorrect", "speaker", "submitted", "correct","name", "x_id", "activeplayercount")
chat_df <- chat_df %>% select(-all_of(columns_to_remove))

#Creating file for user demographics
user_demographics <- player_inputs_df %>%
  select(playerid, data.age, data.gender, data.language, data.education) %>% 

print(head(user_demographics))
write_csv(user_demographics, "user_demographics.csv")


harmonized_datasets <- list(games_df, rounds_df, player_inputs_df, chat_df, survey_df, other_df) %>%
  map(~ .x %>% mutate_if(is.character, fill_na_with_mode) %>% mutate_if(is.numeric, fill_na_with_mean))

# Saving harmonized datasets
write_csv(harmonized_datasets[[1]], "harmonized_games.csv")
write_csv(harmonized_datasets[[2]], "harmonized_rounds.csv")
write_csv(harmonized_datasets[[3]], "harmonized_player_inputs.csv")
write_csv(harmonized_datasets[[4]], "harmonized_multiparty_tangrams.csv")
write_csv(harmonized_datasets[[5]], "harmonized_survey.csv")
write_csv(harmonized_datasets[[6]], "harmonized_other_data.csv")

print("Harmonization complete! Files saved as harmonized CSVs.")
print(head(harmonized_datasets[[1]]))
print(head(harmonized_datasets[[2]]))
print(head(harmonized_datasets[[3]]))
print(head(harmonized_datasets[[4]]))
print(head(harmonized_datasets[[5]]))
print(head(harmonized_datasets[[6]]))


```